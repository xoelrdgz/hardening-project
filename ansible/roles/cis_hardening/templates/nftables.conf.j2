#!/usr/sbin/nft -f
# =============================================================================
# nftables Firewall Configuration - Hardened Server
# Managed by Ansible - CIS Hardening Project
# 
# CIS Ubuntu Server 24.04 LTS Compliant
# Controls: 3.5.1.1, 3.5.2.1-3.5.2.10
# =============================================================================

# Flush existing rules
flush ruleset

# =============================================================================
# IPv4/IPv6 Firewall Rules
# =============================================================================
table inet filter {
    
    # -------------------------------------------------------------------------
    # Rate limiting sets for SSH brute-force protection
    # -------------------------------------------------------------------------
    set ssh_limit {
        type ipv4_addr
        size 65535
        flags dynamic,timeout
        timeout 1m
    }

    # -------------------------------------------------------------------------
    # Input Chain - Default DROP (whitelist approach)
    # -------------------------------------------------------------------------
    chain input {
        type filter hook input priority 0; policy drop;
        
        # Allow established/related connections (stateful firewall)
        ct state established,related accept
        
        # Drop invalid packets
        ct state invalid drop
        
        # Allow loopback traffic
        iif "lo" accept
        
        # Drop traffic to loopback not from loopback
        iif != "lo" ip daddr 127.0.0.0/8 drop
{% if nft_enable_ipv6 | default(false) %}
        iif != "lo" ip6 daddr ::1 drop
{% endif %}

{% if nft_allow_icmp | default(true) %}
        # Allow essential ICMP (ping, etc.)
        ip protocol icmp icmp type { 
            echo-request, 
            echo-reply, 
            destination-unreachable, 
            time-exceeded, 
            parameter-problem 
        } accept
{% if nft_enable_ipv6 | default(false) %}
        # ICMPv6 - required for IPv6 operation
        ip6 nexthdr icmpv6 icmpv6 type { 
            echo-request, 
            echo-reply, 
            destination-unreachable, 
            packet-too-big, 
            time-exceeded, 
            parameter-problem, 
            nd-router-advert, 
            nd-neighbor-solicit, 
            nd-neighbor-advert 
        } accept
{% endif %}
{% endif %}

{% if nft_rate_limit_ssh | default(true) %}
        # SSH with rate limiting (anti-brute-force)
        # Limit: 4 new connections per minute per source IP
        tcp dport {{ ssh_port | default('22') }} ct state new add @ssh_limit { ip saddr limit rate 4/minute burst 8 packets } accept
        tcp dport {{ ssh_port | default('22') }} ct state new drop
{% else %}
        # SSH access (no rate limiting)
        tcp dport {{ ssh_port | default('22') }} accept
{% endif %}

{% if nft_allowed_tcp_ports is defined and nft_allowed_tcp_ports | length > 0 %}
        # Additional allowed TCP ports
        tcp dport { {{ nft_allowed_tcp_ports | join(', ') }} } accept
{% endif %}

{% if nft_allowed_udp_ports is defined and nft_allowed_udp_ports | length > 0 %}
        # Allowed UDP ports
        udp dport { {{ nft_allowed_udp_ports | join(', ') }} } accept
{% endif %}

{% if nft_log_dropped | default(true) %}
        # Log dropped packets (rate limited to prevent log flooding)
        limit rate 5/minute burst 10 packets log prefix "nftables-dropped-input: " level info
{% endif %}

        # Default: drop everything else (already in policy)
        counter drop
    }
    
    # -------------------------------------------------------------------------
    # Forward Chain - Default DROP (this is a server, not a router)
    # -------------------------------------------------------------------------
    chain forward {
        type filter hook forward priority 0; policy drop;
        
{% if nft_log_dropped | default(true) %}
        # Log forwarded packets (should be none on a server)
        limit rate 1/minute log prefix "nftables-forward: " level warn
{% endif %}
        counter drop
    }
    
    # -------------------------------------------------------------------------
    # Output Chain - Default ACCEPT
    # For stricter security, change to drop and whitelist destinations
    # -------------------------------------------------------------------------
    chain output {
        type filter hook output priority 0; policy accept;
        
        # Allow all outbound traffic from this server
        counter accept
    }
}

{% if not nft_enable_ipv6 | default(false) %}
# =============================================================================
# IPv6 Firewall Rules - DROP ALL
# IPv6 is disabled for security. Enable with nft_enable_ipv6: true
# =============================================================================
table ip6 filter {
    chain input {
        type filter hook input priority 0; policy drop;
        counter drop
    }
    
    chain forward {
        type filter hook forward priority 0; policy drop;
        counter drop
    }
    
    chain output {
        type filter hook output priority 0; policy drop;
        counter drop
    }
}
{% endif %}
